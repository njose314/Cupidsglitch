<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON ARCHER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #0a0e27;
            color: #00ffff;
            overflow: hidden;
            font-family: 'Press Start 2P', monospace;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        /* CRT Effects */
        .scanlines {
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.15) 50%, rgba(0,0,0,0.15));
            background-size: 100% 4px;
            position: absolute; 
            inset: 0; 
            pointer-events: none; 
            z-index: 50;
        }
        
        .screen-glow {
            position: absolute; 
            inset: 0;
            background: radial-gradient(circle at center, rgba(0,255,255,0.08) 0%, rgba(255,0,255,0.04) 50%, rgba(0,0,0,0.95) 100%);
            pointer-events: none; 
            z-index: 40;
        }

        /* Enhanced Glass UI */
        .glass-panel {
            background: rgba(10, 14, 39, 0.85);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(0, 255, 255, 0.6);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3), inset 0 0 20px rgba(0, 255, 255, 0.1);
        }

        .glass-toast {
            background: rgba(10, 14, 39, 0.9);
            backdrop-filter: blur(8px);
            border: 2px solid #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4), inset 0 0 15px rgba(0, 255, 255, 0.15);
        }

        /* Refined Neon Text - Readable but Glowing */
        .neon-title { 
            color: #00ffff;
            text-shadow: 0 0 8px #00ffff, 0 0 16px #0088ff;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .neon-label { 
            color: #ffff00;
            text-shadow: 0 0 6px #ffff00;
            font-weight: bold;
        }

        .neon-value { 
            color: #ffff00;
            text-shadow: 0 0 6px #ffff00;
        }

        .neon-button {
            color: #00ffff;
            text-shadow: 0 0 6px #00ffff;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .neon-mission {
            color: #ff00ff;
            text-shadow: 0 0 6px #ff00ff;
        }

        .neon-text {
            color: #00ffff;
            text-shadow: 0 0 6px #00ffff;
        }

        .neon-success {
            color: #ff00ff;
            text-shadow: 0 0 8px #ff00ff;
        }

        #quoteToast {
            transition: opacity 0.5s ease, transform 0.5s ease;
            width: 90%;
            max-width: 450px;
        }

        canvas { 
            display: block; 
            width: 100%; 
            height: 100%; 
        }

        .hidden { 
            display: none !important; 
        }

        /* Button Styles */
        button {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        button:hover {
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.6) !important;
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="h-dvh w-screen flex flex-col items-center justify-center relative">

    <div class="scanlines"></div>
    <div class="screen-glow"></div>
    <canvas id="gameCanvas"></canvas>
    
    <!-- Audio with direct MP3 link -->
    <audio id="bgm" loop preload="auto" crossorigin="anonymous"></audio>

    <!-- HUD -->
    <div id="hud" class="absolute top-4 left-4 right-4 flex justify-between z-30 hidden pointer-events-none px-4">
        <div class="neon-text text-[10px]">ENVELOPES: <span class="neon-value">0/10</span></div>
        <div class="neon-text text-[10px]">HP: <span class="neon-value">â™¥â™¥â™¥</span></div>
    </div>

    <!-- Quote Toast -->
    <div id="quoteToast" class="absolute top-1/4 left-0 right-0 mx-auto text-center pointer-events-none z-50 opacity-0 transform translate-y-4">
        <p class="glass-toast neon-label text-[10px] leading-relaxed p-4" id="quoteText">
            "Locating heart signal..."
        </p>
    </div>

    <!-- Start Screen -->
    <div id="startScreen" class="absolute inset-0 z-40 flex flex-col items-center justify-center bg-black/98 p-6 text-center">
        <h1 class="neon-title mb-8" style="font-size: 2.5rem;">NEON ARCHER</h1>
        
        <div class="glass-panel p-6 mb-8 max-w-sm text-left w-full">
            <h3 class="neon-mission mb-4 border-b-2 border-cyan-500 pb-3" style="font-size: 0.8rem;">MISSION BRIEFING</h3>
            <ul class="text-[9px] neon-text space-y-3 leading-relaxed list-disc pl-5">
                <li><span class="neon-label">GOAL:</span> Crack open <span class="neon-value">10 Love Envelopes</span>.</li>
                <li><span class="neon-label">INTEL:</span> Envelopes are TOUGH. Shoot them repeatedly!</li>
                <li><span class="neon-label">CONTROLS:</span> Drag to move. Shooting is <span class="neon-value">AUTOMATIC</span>.</li>
            </ul>
        </div>

        <button id="startBtn" class="glass-panel px-8 py-4 neon-button text-xs uppercase font-bold">
            â–¶ PLAY
        </button>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/98 p-6 text-center overflow-y-auto">
        <div class="my-auto">
            <h2 id="goTitle" class="neon-title mb-6" style="font-size: 1.8rem;"></h2>
            <div id="goMessage" class="neon-text text-[10px] mb-8 leading-relaxed max-w-sm mx-auto"></div>
            <button id="restartBtn" class="glass-panel px-6 py-4 neon-button text-xs uppercase font-bold">
                â†» RESTART
            </button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const bgm = document.getElementById('bgm');
        
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const hud = document.getElementById('hud');
        const letterDisplay = document.querySelector('#hud .neon-value');
        const hpDisplay = document.querySelectorAll('#hud .neon-value')[1];
        const quoteToast = document.getElementById('quoteToast');
        const quoteText = document.getElementById('quoteText');
        const goTitle = document.getElementById('goTitle');
        const goMessage = document.getElementById('goMessage');
        const startBtn = document.getElementById('startBtn');
        const restartBtn = document.getElementById('restartBtn');

        // --- DIRECT MP3 AUDIO FROM INTERNET ARCHIVE ---
        bgm.src = 'https://archive.org/download/portal-new-synthwave-music/101.%20Ninjacat%20-%20Our%20Electric%20Summer.mp3';
        bgm.volume = 0.6;

        // --- ASSETS & DATA ---
        const ALL_QUOTES = [
            "Are you a keyboard? Because you're my type.",
            "You auto-complete me.",
            "My heart has zero latency with you.",
            "I'd never delete your cookies.",
            "You're the CSS to my HTML.",
            "Overclocking my heart...",
            "Status: 100% In Love.",
            "You are my favorite notification.",
            "Are you Wi-Fi? I'm feeling a connection.",
            "You make my floppy disk a hard drive.",
            "Is your name Google? You have everything I search for.",
            "You had me at 'Hello World'.",
            "My love for you is infinite loop.",
            "You are the root user of my heart.",
            "I want to Ctrl+S you forever.",
            "Are you a glitch? Because I can't take my eyes off you.",
            "You update my software automatically.",
            "Let's pair our devices.",
            "You are my high score.",
            "I'm stuck in your orbit.",
            "Your smile renders perfectly.",
            "Let's Git Commit to each other.",
            "You make my heart beat faster than 5G.",
            "I'd pause my game for you.",
            "You're hotter than my laptop running cyberpunk.",
            "Are you a GPU? Because you make everything look better.",
            "Love.exe has executed successfully.",
            "You're my Player 2.",
            "Let's sync our hearts.",
            "You're the missing pixel in my life.",
            "I'm laggy when you're not around.",
            "You have full admin rights to my heart.",
            "Your interface is beautiful.",
            "Let's connect on a deeper protocol.",
            "You charge my battery.",
            "I'm buffering... admiring you.",
            "Are you Bluetooth? I feel paired.",
            "You're the source code of my happiness.",
            "System Overload: Too much cute.",
            "I'd reboot my life for you.",
            "You're my home page.",
            "Let's encrypt our love.",
            "You're 4K resolution in a 1080p world.",
            "My love bandwidth is unlimited for you.",
            "You're the master key to my heart.",
            "I'm detecting high levels of attraction.",
            "You're my daily reward.",
            "Are you a magnet? I'm attracted.",
            "Let's make some memories in the cloud.",
            "You're better than free Wi-Fi.",
            "I'd trade all my loot for a kiss.",
            "You're the glitch I never want to fix.",
            "My heart runs on your OS.",
            "You're the unexpected update I needed.",
            "Let's go AFK together.",
            "You're my favorite algorithm.",
            "I'm scanning for your love.",
            "You're the logic to my chaos.",
            "I'm compiled just for you.",
            "Let's build a life stack.",
            "You're the best feature, not a bug.",
            "I'm hardcoded to love you.",
            "You make my fans spin fast.",
            "Are you a touchscreen? I want to hold you.",
            "You're the VIP in my server.",
            "Let's duo queue for life.",
            "You're my ultimate ability.",
            "I'm farming XP (Xtra Passion) for you.",
            "You're a legendary drop.",
            "My ping is 0 when I'm with you.",
            "You're the graphics card to my display.",
            "I'd rage quit the world for you.",
            "You're the save point in my day.",
            "Let's level up together.",
            "You're the cheat code to happiness.",
            "I'm streaming my love to you.",
            "You're the best skin in the game.",
            "My heart has a dedicated server for you.",
            "You're the raid boss of beauty.",
            "Let's mod this world together.",
            "You're the expansion pack to my life.",
            "I'm gridlocked on you.",
            "You're the syntax to my sugar.",
            "I'd debug your code any day.",
            "You're the kernel of my OS.",
            "I'm overflowing with love.",
            "You're the binary to my soul.",
            "Let's run a diagnostic on our love (Result: Perfect).",
            "You're the cache I never clear.",
            "I'm hooked on your API.",
            "You're the bandwidth to my heart.",
            "I'm formatted for you.",
            "You're the patch note I waited for.",
            "Let's initiate the cuddle protocol.",
            "You're the verified tick in my life.",
            "I'm subscribing to your heart.",
            "You're the notification I wait for."
        ];
        let gameQuotes = [];

        const COLORS = {
            player: '#00ffff',
            bullet: '#00ffff',
            enemy: '#ff0055',
            letter: '#ffffff',
            bg: '#0a0e27'
        };

        // Entities
        let player = { x: 0, y: 0, w: 40, h: 40, hp: 3 };
        let bullets = [];
        let enemies = [];
        let collectibles = [];
        let particles = [];
        let stars = [];

        // State
        let state = {
            running: false,
            won: false,
            score: 0,
            letters: 0,
            frameCount: 0,
            lastTime: 0,
            slowMo: 0
        };

        // Input
        let touchActive = false;
        let inputX = 0, inputY = 0;
        const TOUCH_OFFSET_Y = 75; 

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if(!state.running) {
                player.x = canvas.width / 2;
                player.y = canvas.height * 0.8;
            }
        }
        window.addEventListener('resize', resize);
        resize();

        function updateInput(x, y) {
            const rect = canvas.getBoundingClientRect();
            inputX = x - rect.left;
            inputY = y - rect.top;
            touchActive = true;
        }
        canvas.addEventListener('touchstart', e => { e.preventDefault(); updateInput(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
        canvas.addEventListener('touchmove', e => { e.preventDefault(); updateInput(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
        canvas.addEventListener('touchend', () => touchActive = false);
        canvas.addEventListener('mousedown', e => updateInput(e.clientX, e.clientY));
        canvas.addEventListener('mousemove', e => { if(touchActive) updateInput(e.clientX, e.clientY); });
        canvas.addEventListener('mouseup', () => touchActive = false);

        // --- GAME LOGIC ---

        function shuffleQuotes() {
            gameQuotes = [...ALL_QUOTES].sort(() => 0.5 - Math.random()).slice(0, 15);
        }

        function spawnEnemy() {
            const size = 30;
            enemies.push({
                x: Math.random() * (canvas.width - size),
                y: -50,
                w: size, h: size,
                speed: 4 + Math.random() * 3,
                hp: 1,
                angle: 0
            });
        }

        function spawnEnvelope() {
            const size = 50;
            collectibles.push({
                x: Math.random() * (canvas.width - size),
                y: -50,
                w: size, h: size * 0.7,
                speed: 2,
                wobbleOffset: Math.random() * 100,
                hp: 20,
                maxHp: 20,
                hitFlash: 0
            });
        }

        function triggerQuote() {
            state.slowMo = 90; 
            const quote = gameQuotes[state.letters % gameQuotes.length];
            quoteText.innerText = quote;
            quoteToast.style.opacity = '1';
            quoteToast.style.transform = 'translateY(0)';
            setTimeout(() => {
                quoteToast.style.opacity = '0';
                quoteToast.style.transform = 'translateY(10px)';
            }, 3000);
        }

        function winGame() {
            state.won = true;
            enemies = [];
            collectibles = [];
            
            for(let i=0; i<80; i++) {
                createParticle(canvas.width/2, canvas.height/2, COLORS.player, 15);
                createParticle(canvas.width/2, canvas.height/2, '#ff00ff', 15);
            }
            if(navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200, 50, 500]);

            setTimeout(() => {
                state.running = false;
                bgm.pause();
                hud.classList.add('hidden');
                gameOverScreen.classList.remove('hidden');
                goTitle.innerText = "MISSION COMPLETE";
                goMessage.innerHTML = `
                    <span class="neon-success">SYSTEM STABILIZED.</span><br><br>
                    I love you so much.<br>
                    Your kisses still give me real butterflies in this digital world.<br><br>
                    <span style="font-size: 0.7rem; color: #ff00ff; text-shadow: 0 0 6px #ff00ff;">I love making these mini games ONLY and ONLY for you. ðŸ˜˜</span><br><br>
                    <span class="neon-success">- with love,<br>Your designheaded man</span>
                `;
            }, 2500);
        }

        function createParticle(x, y, color, speedMult = 1) {
            particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 8 * speedMult,
                vy: (Math.random() - 0.5) * 8 * speedMult,
                life: 1.0,
                color: color
            });
        }

        function update(dt) {
            if (!state.running) return;

            let timeScale = 1;
            if (state.slowMo > 0) {
                timeScale = 0.2;
                state.slowMo--;
            }

            if (touchActive && !state.won) {
                let targetY = inputY - TOUCH_OFFSET_Y;
                player.x += (inputX - player.x) * 0.25;
                player.y += (targetY - player.y) * 0.25;
                player.x = Math.max(20, Math.min(canvas.width - 20, player.x));
                player.y = Math.max(20, Math.min(canvas.height - 20, player.y));
            } else if (state.won) {
                player.y -= 3;
                player.x += Math.sin(state.frameCount * 0.1) * 5;
            }

            // Automatic Fire
            if (touchActive && state.frameCount % 5 === 0 && !state.won) {
                bullets.push({ x: player.x, y: player.y - 20, w: 4, h: 20, speed: 15 });
                if(navigator.vibrate) navigator.vibrate(5);
            }

            bullets.forEach((b, i) => {
                b.y -= b.speed * timeScale;
                if (b.y < -20) bullets.splice(i, 1);
            });

            if (!state.won) {
                if (state.frameCount % Math.floor(30/timeScale) === 0) spawnEnemy();
                if (collectibles.length < 1 && state.frameCount % 60 === 0) spawnEnvelope();
            }

            enemies.forEach((e, i) => {
                e.y += e.speed * timeScale;
                e.angle += 0.1;
                const dist = Math.hypot(player.x - (e.x + e.w/2), player.y - (e.y + e.h/2));
                if (dist < 30 && !state.won) {
                    player.hp--;
                    updateHP();
                    enemies.splice(i, 1);
                    createParticle(player.x, player.y, COLORS.player);
                    if(navigator.vibrate) navigator.vibrate(200);
                    if(player.hp <= 0) endGame();
                }
                if (e.y > canvas.height) enemies.splice(i, 1);
            });

            collectibles.forEach((c, i) => {
                c.y += c.speed * timeScale;
                c.x += Math.sin((c.y + c.wobbleOffset) * 0.05) * 1.5; 
                if(c.hitFlash > 0) c.hitFlash--;

                bullets.forEach((b, bIdx) => {
                    if (b.x > c.x && b.x < c.x + c.w && b.y > c.y && b.y < c.y + c.h) {
                        c.hp--;
                        c.hitFlash = 5;
                        c.w -= 0.5;
                        c.h -= 0.3;
                        bullets.splice(bIdx, 1);
                        createParticle(b.x, b.y, '#fff', 0.5);
                        if (c.hp <= 0) {
                            state.letters++;
                            letterDisplay.innerText = state.letters + "/10";
                            createParticle(c.x + c.w/2, c.y + c.h/2, COLORS.letter, 2);
                            if(navigator.vibrate) navigator.vibrate([30, 30, 30]);
                            triggerQuote();
                            collectibles.splice(i, 1);
                            if(state.letters >= 10) winGame();
                        }
                    }
                });
                if (c.y > canvas.height) collectibles.splice(i, 1);
            });

            bullets.forEach((b, bIdx) => {
                enemies.forEach((e, eIdx) => {
                    if (b.x > e.x && b.x < e.x + e.w && b.y > e.y && b.y < e.y + e.h) {
                        enemies.splice(eIdx, 1);
                        bullets.splice(bIdx, 1);
                        createParticle(e.x + e.w/2, e.y + e.h/2, COLORS.enemy);
                    }
                });
            });

            particles.forEach((p, i) => {
                p.x += p.vx * timeScale;
                p.y += p.vy * timeScale;
                p.life -= 0.05;
                if (p.life <= 0) particles.splice(i, 1);
            });

            stars.forEach(s => {
                s.y += s.speed * timeScale;
                if (s.y > canvas.height) {
                    s.y = 0;
                    s.x = Math.random() * canvas.width;
                }
            });
        }

        // --- DRAWING ---
        function drawBow(x, y, color) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 4;
            ctx.shadowBlur = 20;
            ctx.shadowColor = color;
            
            // Bow curve
            ctx.beginPath();
            ctx.arc(x, y + 10, 25, Math.PI * 1.1, Math.PI * 1.9);
            ctx.stroke();
            
            // Bow string
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x - 20, y + 3);
            ctx.lineTo(x + 20, y + 3);
            ctx.stroke();
            
            ctx.shadowBlur = 0;
        }

        function drawNeonArrow(x, y, color) {
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = 2;
            ctx.shadowBlur = 20;
            ctx.shadowColor = color;
            
            // Shaft
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x, y + 20);
            ctx.stroke();
            
            // Head
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x - 5, y + 8);
            ctx.lineTo(x + 5, y + 8);
            ctx.closePath();
            ctx.fill();
            
            ctx.shadowBlur = 0;
        }

        function drawHeart(x, y, size, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            let topCurveHeight = size * 0.3;
            ctx.moveTo(x, y + topCurveHeight);
            ctx.bezierCurveTo(x, y, x - size / 2, y, x - size / 2, y + topCurveHeight);
            ctx.bezierCurveTo(x - size / 2, y + (size + topCurveHeight) / 2, x, y + (size + topCurveHeight) / 2, x, y + size);
            ctx.bezierCurveTo(x, y + (size + topCurveHeight) / 2, x + size / 2, y + (size + topCurveHeight) / 2, x + size / 2, y + topCurveHeight);
            ctx.bezierCurveTo(x + size / 2, y, x, y, x, y + topCurveHeight);
            ctx.closePath();
            ctx.fill();
        }

        function drawEnvelope(c) {
            let x = c.x, y = c.y, w = c.w, h = c.h;
            ctx.fillStyle = c.hitFlash > 0 ? '#fff' : '#eee';
            if (c.hitFlash > 0) x += (Math.random() - 0.5) * 4;
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + w/2, y + h/1.5);
            ctx.lineTo(x + w, y);
            ctx.stroke();
            drawHeart(x + w/2, y + h/1.5 - 5, 10, '#ff0055');
            if (c.hp < c.maxHp) {
                ctx.fillStyle = '#333';
                ctx.fillRect(x, y - 8, w, 4);
                ctx.fillStyle = '#00ffff';
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#00ffff';
                ctx.fillRect(x, y - 8, w * (c.hp / c.maxHp), 4);
                ctx.shadowBlur = 0;
            }
        }

        function draw() {
            ctx.fillStyle = COLORS.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = 'rgba(0, 255, 255, 0.4)';
            stars.forEach(s => {
                ctx.shadowBlur = 8;
                ctx.shadowColor = '#00ffff';
                ctx.fillRect(s.x, s.y, s.size, s.size);
                ctx.shadowBlur = 0;
            });

            if(state.running || state.won) {
                if(touchActive && !state.won) {
                    ctx.strokeStyle = 'rgba(0, 255, 255, 0.3)';
                    ctx.setLineDash([5, 5]);
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(player.x, player.y + 20);
                    ctx.lineTo(inputX, inputY);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
                drawBow(player.x, player.y, COLORS.player);
            }

            bullets.forEach(b => drawNeonArrow(b.x, b.y, COLORS.bullet));

            enemies.forEach(e => {
                ctx.fillStyle = COLORS.enemy;
                ctx.save();
                ctx.translate(e.x + e.w/2, e.y + e.h/2);
                ctx.rotate(Math.sin(e.angle)*0.2);
                ctx.shadowBlur = 15;
                ctx.shadowColor = COLORS.enemy;
                ctx.fillRect(-e.w/2, -e.h/2, e.w, e.h);
                ctx.fillStyle = '#000';
                ctx.fillRect(-e.w/4, -e.h/4, 5, 5);
                ctx.fillRect(e.w/4 - 5, -e.h/4, 5, 5);
                ctx.restore();
                ctx.shadowBlur = 0;
            });

            collectibles.forEach(c => drawEnvelope(c));

            particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life;
                ctx.shadowBlur = 10;
                ctx.shadowColor = p.color;
                ctx.fillRect(p.x, p.y, 4, 4);
                ctx.globalAlpha = 1.0;
                ctx.shadowBlur = 0;
            });
        }

        function loop(timestamp) {
            const dt = timestamp - state.lastTime;
            state.lastTime = timestamp;
            state.frameCount++;
            update(dt);
            draw();
            requestAnimationFrame(loop);
        }

        function init() {
            stars = [];
            for(let i=0; i<100; i++) {
                stars.push({
                    x: Math.random() * window.innerWidth,
                    y: Math.random() * window.innerHeight,
                    size: Math.random() * 2.5,
                    speed: 1 + Math.random() * 4
                });
            }
            player.x = window.innerWidth / 2;
            player.y = window.innerHeight * 0.8;
        }

        function startGame() {
            bgm.currentTime = 0;
            const playPromise = bgm.play();
            
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log('Audio play initiated');
                });
            }
            
            shuffleQuotes();
            state.running = true;
            state.won = false;
            state.score = 0;
            state.letters = 0;
            player.hp = 3;
            bullets = [];
            enemies = [];
            collectibles = [];
            
            player.x = canvas.width / 2;
            player.y = canvas.height * 0.8;
            
            letterDisplay.innerText = "0/10";
            updateHP();
            
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            hud.classList.remove('hidden');
        }

        function endGame() {
            state.running = false;
            bgm.pause();
            hud.classList.add('hidden');
            gameOverScreen.classList.remove('hidden');
            goTitle.innerText = "SYSTEM CRASH";
            goMessage.innerHTML = `<span class="neon-success">THE GLITCH WON.</span><br><br>REBOOT AND TRY AGAIN.`;
            if(navigator.vibrate) navigator.vibrate(300);
        }

        function updateHP() {
            hpDisplay.innerText = "â™¥".repeat(player.hp);
        }

        // Event listeners
        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', startGame);

        // Allow audio to play on any user interaction
        document.addEventListener('click', () => {
            if (bgm.paused && state.running) {
                bgm.play().catch(e => console.log('Audio play error:', e));
            }
        });

        init();
        requestAnimationFrame(loop);

    </script>
</body>
</html>
